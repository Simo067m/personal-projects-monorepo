{% extends "investment/base.html" %}

{% block investment_content %}
<div class="portal-container">
    
    <!-- HEADER -->
    <div style="grid-column: span 12; margin-bottom: 20px;">
        <h1 style="font-weight: 400; letter-spacing: -0.02em;">Manage Portfolio</h1>
        <p class="card-desc">Maintain your local ledger for assets, transactions, and EOD pricing.</p>
    </div>

    <!-- THREE-COLUMN FORM GRID -->
    <div class="portal-column w-full" style="grid-auto-rows: auto;">
        
        <!-- 1. ADD ASSET -->
        <div class="form-card w-third">
            <div class="card-label">Identity</div>
            <h3 class="card-title">Add Asset</h3>
            <form action="{{ url_for('investment_web.handle_add_asset') }}" method="POST">
                <div class="input-group">
                    <label>Symbol</label>
                    <input type="text" name="symbol" placeholder="e.g. NOVO-B" required>
                </div>
                <div class="input-group">
                    <label>Name</label>
                    <input type="text" name="name" placeholder="e.g. Novo Nordisk" required>
                </div>
                <div class="input-group">
                    <label>Type</label>
                    <input type="text" name="asset_type" id="field-type" placeholder="Stock" required>
                    <div class="preset-container">
                        <span class="preset-tag" onclick="fill('field-type', 'Stock')">Stock</span>
                        <span class="preset-tag" onclick="fill('field-type', 'ETF')">ETF</span>
                    </div>
                </div>
                <div class="input-group">
                    <label>Currency</label>
                    <input type="text" name="currency" id="field-curr" placeholder="DKK" required>
                    <div class="preset-container">
                        <span class="preset-tag" onclick="fill('field-curr', 'DKK')">DKK</span>
                        <span class="preset-tag" onclick="fill('field-curr', 'EUR')">EUR</span>
                    </div>
                </div>
                <button type="submit" class="btn-submit mt-auto">Register</button>
            </form>
        </div>

        <!-- 2. ADD TRANSACTION -->
        <div class="form-card w-third">
            <div class="card-label">Ledger</div>
            <h3 class="card-title">Add Trade</h3>
            <form action="{{ url_for('investment_web.handle_add_transaction') }}" method="POST">
                <div class="input-group">
                    <label>Symbol</label>
                    <input type="text" name="symbol" id="trans-symbol" placeholder="NOVO-B" required>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="input-group">
                        <label>Action</label>
                        <select name="transaction_type">
                            <option value="buy">BUY</option>
                            <option value="sell">SELL</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Date</label>
                        <input type="date" name="date" required>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="input-group">
                        <label>Qty</label>
                        <input type="number" step="any" name="quantity" required>
                    </div>
                    <div class="input-group">
                        <label>Price</label>
                        <input type="number" step="any" name="price_per_unit" required>
                    </div>
                </div>
                <button type="submit" class="btn-submit mt-auto">Log Trade</button>
            </form>
        </div>

        <!-- 3. ADD EOD PRICE (THE RETURNED FORM) -->
        <div class="form-card w-third" style="border-color: var(--accent-investment);">
            <div class="card-label" style="color: var(--accent-investment);">Market Data</div>
            <h3 class="card-title">Manual EOD Update</h3>
            <form action="{{ url_for('investment_web.handle_add_price') }}" method="POST">
                <div class="input-group">
                    <label>Symbol</label>
                    <input type="text" name="symbol" id="price-symbol" placeholder="Select from list below" required>
                </div>
                <div class="input-group">
                    <label>Date</label>
                    <input type="date" name="date" id="price-date" required>
                </div>
                <div class="input-group">
                    <label>Closing Price (Local)</label>
                    <input type="number" step="0.0001" name="price" placeholder="0.00" required>
                </div>
                <button type="submit" class="btn-submit mt-auto" style="background: var(--accent-investment);">Update Price</button>
            </form>
        </div>

    </div>

    <!-- ASSET LIST (With Auto-Fill Helper) -->
    <div class="portal-column w-full" style="margin-top: 20px; grid-auto-rows: auto;">
        <div class="bento-card w-full">
            <div class="card-label">Inventory / Click Symbol to Update Price</div>
            <table class="holdings-table">
                <thead>
                    <tr>
                        <th>Symbol</th>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Currency</th>
                    </tr>
                </thead>
                <tbody>
                    {% for asset in assets %}
                    <tr onclick="fillPriceForm('{{ asset[1] }}')" style="cursor: pointer;">
                        <td style="font-family: var(--mono-font); color: var(--accent-investment); font-weight: bold;">
                            {{ asset[1] }}
                        </td>
                        <td>{{ asset[2] }}</td>
                        <td><span class="asset-type-pill">{{ asset[3] }}</span></td>
                        <td>{{ asset[4] }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // General fill helper
    function fill(id, val) {
        document.getElementById(id).value = val;
    }

    // Specialized helper for manual price entry
    function fillPriceForm(symbol) {
        document.getElementById('price-symbol').value = symbol;
        document.getElementById('trans-symbol').value = symbol; // Also fills transaction symbol just in case
        
        // Auto-set date to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('price-date').value = today;
        
        // Visual feedback
        const priceCard = document.getElementById('price-symbol').closest('.form-card');
        priceCard.style.transform = 'scale(1.02)';
        setTimeout(() => priceCard.style.transform = 'scale(1)', 200);

        const transCard = document.getElementById('trans-symbol').closest('.form-card');
        transCard.style.transform = 'scale(1.02)';
        setTimeout(() => transCard.style.transform = 'scale(1)', 200);
    }
</script>
{% endblock %}